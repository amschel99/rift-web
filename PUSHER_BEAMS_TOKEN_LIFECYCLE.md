# Pusher Beams Token & Authentication Lifecycle

## Token Types

### 1. **Auth Token (Short-Lived)** â±ï¸

- **Duration:** A few minutes
- **Purpose:** One-time authentication during `.setUserId()`
- **Generated by:** Your backend `/notifications/pusher-beams-auth`
- **Expires:** Yes, quickly!

### 2. **Device Registration (Permanent)** â™¾ï¸

- **Duration:** Forever (until cleared)
- **Purpose:** Link device to user
- **Stored in:** Browser IndexedDB
- **Expires:** No!

---

## Complete Lifecycle

### First Time (New Device)

```
User enables notifications
  â†“
1. beamsClient.start()
   â†’ Device registered with Pusher
  â†“
2. Check: getUserId() === null
   â†’ Not authenticated yet
  â†“
3. Create TokenProvider
   â†’ Points to /notifications/pusher-beams-auth
  â†“
4. Call: setUserId(userId, tokenProvider)
   â†’ TokenProvider requests auth token from backend
   â†’ Backend generates token: beamsClient.generateToken(userId)
   â†’ Token valid for ~5 minutes
   â†’ Frontend sends token to Pusher Beams
   â†’ Pusher Beams links device to userId
  â†“
5. Device now permanently linked! âœ…
   â†’ Stored in IndexedDB
   â†’ No expiration!
```

### Subsequent Visits (Same Device)

```
User returns to app (hours/days later)
  â†“
1. beamsClient.start()
   â†’ Device still registered
  â†“
2. Check: getUserId() === userId
   â†’ Already authenticated! âœ…
  â†“
3. Skip setUserId()
   â†’ No auth token needed!
   â†’ No backend call!
  â†“
4. Notifications work immediately! ğŸ‰
```

### New Device (Same User)

```
User enables notifications on Device 2
  â†“
1. beamsClient.start()
   â†’ New device registered
  â†“
2. Check: getUserId() === null
   â†’ Not authenticated on this device
  â†“
3. Call: setUserId(userId, tokenProvider)
   â†’ New auth token generated
   â†’ Device 2 now linked to userId
  â†“
4. Both Device 1 AND Device 2 receive notifications! âœ…
```

---

## Does the Link Expire?

### âŒ NO! The device-user link is permanent:

```
Day 1:   setUserId("user_12345") â†’ Device linked
Day 2:   start() â†’ Still linked âœ…
Day 30:  start() â†’ Still linked âœ…
Day 365: start() â†’ Still linked âœ…
```

### Only broken if:

1. **User clears browser data** (IndexedDB deleted)
2. **Incognito/Private mode** (no persistence)
3. **Different browser** (Chrome vs Firefox = different devices)
4. **Manual clear:** `beamsClient.clearAllState()`
5. **Backend deletes user:** `beamsClient.deleteUser(userId)`

---

## Backend Token Generation

```typescript
// POST /notifications/pusher-beams-auth
app.post("/notifications/pusher-beams-auth", async (req, res) => {
  const userId = req.user.id; // From your auth

  // This token expires in ~5 minutes
  // But only used once during setUserId()
  const beamsToken = beamsClient.generateToken(userId);

  res.json(beamsToken);
  // {
  //   "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
  // }
});
```

**Token expiration doesn't matter** because:

- It's only used once during initial authentication
- Device registration is permanent after that
- Subsequent app opens don't need a new token

---

## Notification Delivery Timeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device Registration                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Day 1: setUserId() â†’ Device linked to user                  â”‚
â”‚        Auth token expires after 5 minutes âœ“                  â”‚
â”‚        Device link: PERMANENT â™¾ï¸                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Notifications (Day 1-1000+)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend: publishToUsers(["user_12345"])                     â”‚
â”‚    â†“                                                         â”‚
â”‚ Pusher Beams: Lookup all devices for user_12345             â”‚
â”‚    â†“                                                         â”‚
â”‚ Deliver to: Device 1, Device 2, Device 3... âœ…              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Benefits

1. **Short-lived auth token** (5 min)

   - Limits exposure if intercepted
   - Only used during registration

2. **Permanent device link**

   - No repeated auth calls
   - Better performance
   - Better UX

3. **Backend verification**
   - Each device must authenticate with your backend
   - You control who can register

---

## Summary

**Q: Does the token expire?**
**A:** Yes, but it doesn't matter!

- Auth token expires in ~5 minutes â±ï¸
- Only used once during `.setUserId()`
- Device link is permanent â™¾ï¸
- Notifications work forever (until user clears data)

**Q: Will users stop receiving notifications?**
**A:** NO! Once authenticated, they'll receive notifications indefinitely until they:

- Clear browser data
- Use a different device/browser
- You manually remove them

---

## Code Check

Your updated code now:

1. âœ… Checks if already authenticated (`getUserId()`)
2. âœ… Only calls `setUserId()` if needed
3. âœ… Avoids unnecessary auth token requests
4. âœ… Works across app restarts/refreshes

Perfect! ğŸ‰
