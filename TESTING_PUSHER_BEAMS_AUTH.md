# Testing Pusher Beams Authentication (Localhost)

## Current Configuration ‚úÖ

Frontend is configured to use:
```
http://localhost:8000/notifications/pusher-beams-auth
```

## What Will Happen When You Enable Notifications

### 1. Frontend Makes Request

```http
POST http://localhost:8000/notifications/pusher-beams-auth
Headers:
  Authorization: Bearer <user_access_token>
```

### 2. Backend Must Respond With

```json
{
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

Generated by:
```typescript
const beamsToken = beamsClient.generateToken(userId);
res.json(beamsToken);
```

## Testing Steps

### Step 1: Start Your Backend

```bash
# Make sure backend is running on localhost:8000
cd your-backend-folder
npm run dev
```

### Step 2: Add Auth Endpoint to Backend

```typescript
// POST /notifications/pusher-beams-auth
app.post('/notifications/pusher-beams-auth', authenticateUser, async (req, res) => {
  const userId = req.user.id; // From your auth middleware
  
  if (!userId) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  try {
    const beamsToken = beamsClient.generateToken(userId);
    res.json(beamsToken);
  } catch (error) {
    console.error('Pusher Beams auth error:', error);
    res.status(500).json({ error: 'Failed to generate token' });
  }
});
```

### Step 3: Start Frontend

```bash
npm run dev
# Frontend runs on http://localhost:5173
```

### Step 4: Enable Notifications

1. Open browser to `http://localhost:5173`
2. Log in
3. Click "Enable Notifications"
4. Watch the console

### Step 5: Check Console Logs

**‚úÖ Success - You should see:**
```
üìù [Pusher Beams] Starting registration...
üìù [Pusher Beams] Instance ID: fd7e39bb-7564-47f4-b370-2fc87cf8d4e5
‚úÖ [Pusher Beams] Client started successfully
‚úÖ [Pusher Beams] Device registered with ID: abc123-def456...
üìù [Pusher Beams] Authenticating user: user_12345
‚úÖ [Pusher Beams] User authenticated: user_12345
‚úÖ [Pusher Beams] Registered with backend
‚úÖ [Pusher Beams] Subscribed to interest: user_12345
```

**‚ùå Error - Auth endpoint missing:**
```
‚ùå [Pusher Beams] Failed to enable notifications: 
Error: Failed to fetch token from http://localhost:8000/notifications/pusher-beams-auth
```

### Step 6: Check Network Tab

Open DevTools ‚Üí Network ‚Üí Filter: `pusher-beams-auth`

**Request:**
```http
POST http://localhost:8000/notifications/pusher-beams-auth
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response (Success):**
```json
Status: 200 OK
{
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

## Testing Multi-Device

### Device 1 (Chrome):
1. Enable notifications
2. Note the userId in console: `user_12345`

### Device 2 (Firefox or Incognito):
1. Log in as same user
2. Enable notifications
3. Note the userId in console: `user_12345` (same!)

### Send Test Notification:
```bash
# From your backend
curl -X POST 'http://localhost:8000/project/notifications/test' \
  -H 'Content-Type: application/json' \
  -H 'X-API-KEY: your_api_key' \
  -H 'X-Project-ID: your_project_id' \
  -d '{
    "subscriberId": "user_12345",
    "message": "Testing multi-device!",
    "title": "Test",
    "targetUrl": "https://wallet.riftfi.xyz/app"
  }'
```

**Expected:** BOTH Device 1 AND Device 2 receive the notification! ‚úÖ

## Troubleshooting

### Error: "Failed to fetch token"

**Cause:** Backend endpoint not implemented or not running

**Fix:**
1. Check backend is running: `curl http://localhost:8000/health`
2. Add the auth endpoint (see Step 2 above)
3. Restart backend

### Error: "Unauthorized"

**Cause:** Auth token not being sent or invalid

**Fix:**
1. Check localStorage has token: `localStorage.getItem('token')`
2. Verify auth middleware on backend accepts the token
3. Check Authorization header in Network tab

### Error: "generateToken is not a function"

**Cause:** Pusher Beams SDK not installed on backend

**Fix:**
```bash
npm install @pusher/push-notifications-server
```

### No errors but notifications don't arrive

**Cause:** Backend using `publishToInterests` instead of `publishToUsers`

**Fix:**
```typescript
// ‚ùå Wrong
await beamsClient.publishToInterests([userId], {...});

// ‚úÖ Correct
await beamsClient.publishToUsers([userId], {...});
```

## Production Configuration

Once tested on localhost, update for production:

**.env.production:**
```bash
VITE_API_URL=https://api.riftfi.xyz
```

The code will automatically use production URL when deployed!

---

Ready to test! üöÄ

